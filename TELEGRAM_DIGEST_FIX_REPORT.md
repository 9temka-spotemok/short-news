# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–∞–π–¥–∂–µ—Å—Ç–∞–º–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Telegram –±–æ—Ç–∞

## üîç –ü—Ä–æ–±–ª–µ–º–∞

–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–ª–∏ –¥–∞–π–¥–∂–µ—Å—Ç—ã —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∑–∞–ø–∏—Å–µ–π `UserPreferences` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

### –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏** —Å–æ–∑–¥–∞–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç `User`, –Ω–æ **–ù–ï —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å** `UserPreferences`
2. **–°–∏—Å—Ç–µ–º–∞ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤** –∏—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å `digest_enabled=True` –∏ `telegram_enabled=True`
3. **Telegram –±–æ—Ç** –Ω–µ –º–æ–≥ –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ `telegram_chat_id`, –ø–æ—Ç–æ–º—É —á—Ç–æ –∑–∞–ø–∏—Å—å `UserPreferences` –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞
4. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å** —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É `/preferences/digest` –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `backend/app/api/v1/endpoints/auth.py`

–î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ `UserPreferences` –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```python
# Create default user preferences for new user
logger.info(f"Creating default preferences for user {new_user.id}")
user_preferences = UserPreferences(
    id=uuid.uuid4(),
    user_id=new_user.id,
    subscribed_companies=[],
    interested_categories=[],
    keywords=[],
    notification_frequency='daily',
    digest_enabled=False,  # Disabled by default
    digest_frequency='daily',
    digest_custom_schedule={},
    digest_format='short',
    digest_include_summaries=True,
    telegram_chat_id=None,
    telegram_enabled=False,  # Disabled by default
    timezone='UTC',
    week_start_day=0
)
db.add(user_preferences)
await db.commit()
```

### 2. –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–§–∞–π–ª:** `backend/fix_missing_user_preferences.py`

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–æ–∑–¥–∞–µ—Ç `UserPreferences` –¥–ª—è —Ç–µ—Ö, —É –∫–æ–≥–æ –∏—Ö –Ω–µ—Ç.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. **–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
   ```bash
   curl -X POST "http://localhost:8000/api/v1/auth/register" \
        -H "Content-Type: application/json" \
        -d '{"email": "test_telegram@example.com", "password": "TestPass123", "full_name": "Test Telegram User"}'
   ```

2. **–ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
   ```
   UserPreferences found: digest_enabled=False, telegram_enabled=False
   ```

3. **–ü—Ä–æ–≤–µ—Ä–µ–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:**
   ```
   ‚úÖ All users already have UserPreferences
   ```

## üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

–î–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

- `digest_enabled`: **false** (–¥–∞–π–¥–∂–µ—Å—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã)
- `digest_frequency`: **daily** (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
- `digest_format`: **short** (–∫—Ä–∞—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç)
- `digest_include_summaries`: **true** (–≤–∫–ª—é—á–∞—Ç—å —Å–∞–º–º–∞—Ä–∏)
- `telegram_enabled`: **false** (Telegram –æ—Ç–∫–ª—é—á–µ–Ω)
- `telegram_chat_id`: **null** (–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
- `notification_frequency`: **daily** (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)

## üîÑ –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –¥–∞–π–¥–∂–µ—Å—Ç—ã —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–æ:

1. **–í–æ–π—Ç–∏ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** –∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤
2. **–í–∫–ª—é—á–∏—Ç—å –¥–∞–π–¥–∂–µ—Å—Ç—ã** (`digest_enabled = true`)
3. **–î–æ–±–∞–≤–∏—Ç—å Chat ID** –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
4. **–í–∫–ª—é—á–∏—Ç—å Telegram** (`telegram_enabled = true`)

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ **–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç `UserPreferences` –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** —É–∂–µ –∏–º–µ—é—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ **Telegram –±–æ—Ç** –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ `telegram_chat_id`
- ‚úÖ **–°–∏—Å—Ç–µ–º–∞ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤** —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `backend/app/api/v1/endpoints/auth.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ UserPreferences
- `backend/fix_missing_user_preferences.py` - –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:
- `backend` - –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- ‚úÖ –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ UserPreferences
- ‚úÖ –õ–æ–≥–∏–∫–∞ Telegram –±–æ—Ç–∞
- ‚úÖ Celery –∑–∞–¥–∞—á–∏ –¥–ª—è –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤



